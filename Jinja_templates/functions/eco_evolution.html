{% extends 'functions/base.html' %}

<!-- ---------------------------------------------------------------------------------------------------- -->

{% block title %} 社会经济演化分析系统 {% endblock %}

<!-- ---------------------------------------------------------------------------------------------------- -->

{% block stylesheets %}
    <link rel="stylesheet" href="{{ static('plg/sweetalert.css') }}">
    <link rel="stylesheet" href="{{ static('plg/bootstrap-3.4.1-dist/css/bootstrap.min.css') }}">
    <link rel="stylesheet" href="{{ static('plg/font-awesome-4.7.0/css/font-awesome.min.css') }}">
    <style>
        body {
            background: #337ab7;
        }

        h5 {
            color: #d4d1d1;
        }

        label {
            font-weight: 300;
        }

        .fa {
            margin-left: 8px;
        }

        .text-blue {
            color: #153974 !important;
            font-weight: 500;
            font-size: 1.6rem;
        }

        #A_container, #B_container, #C_container, #D_container {
            position: relative;
            box-shadow: 0 0 10px 5px rgba(75, 145, 173, 0.44);
            padding: 10px;
            border-radius: 9px;
        }

        .form-select {
            width: 100px;
            position: absolute;
            top: 10px;
            right: 25px;
            z-index: 99;
        }
    </style>
{% endblock %}

{% block nav %}
    {# 导航栏 #}
    <nav class="navbar navbar-default" style="border-radius: 0; margin-bottom: 0">
        <div class="container-fluid">
            <div class="navbar-header">
                <a class="navbar-brand" style="padding: 5px; padding-left: 10px; padding-top: 0;" href="#"><img
                        src="{{ static('img/logo.png') }}" width="160" style="vertical-align: -10px"></a>
                <a class="navbar-brand" href="#"><small>（Beta 1.0）</small></a>
            </div>

            <div class="collapse navbar-collapse" id="bs-example-navbar-collapse-1">
                <ul class="nav navbar-nav">
                    <li><a class="text-blue" href="/"><span class="fa fa-home"></span> 系统主页</a></li>
                    <li><a class="text-blue" href="/mul_source/"><span {% if path == 'mul_source' %}
                        style="color: dodgerblue;font-weight: bold"
                    {% endif %}><span class="fa fa-database"></span> 多源数据融合感知系统</span></a>
                    </li>
                    <li><a class="text-blue" href="/eco_evolution/"><span {% if path == 'eco_evolution' %}
                        style="color: dodgerblue;font-weight: bold"
                    {% endif %}><span class="fa fa-line-chart"></span>
                            社会经济演化分析系统</span></a></li>
                    <li><a class="text-blue" href="/dpm_warning/"><span {% if path == 'dpm_warning' %}
                        style="color: dodgerblue;font-weight: bold"
                    {% endif %}><span class="fa fa-bell"></span> 社会经济发展预警系统</span></a>
                    </li>
                    <li><a class="text-blue" href="/lod_warning/"><span {% if path == 'lod_warning' %}
                        style="color: dodgerblue;font-weight: bold"
                    {% endif %}
                    ><span
                            class="fa fa-cubes"></span> 中长期负荷预警系统</span></a></li>
                    <li><a class="text-blue" href="/res_analysis/"><span {% if path == 'res_analysis' %}
                        style="color: dodgerblue;font-weight: bold"
                    {% endif %}><span class="fa fa-id-card-o"></span>
                        社会求职简历数据可视化平台</span></a></li>
                </ul>
                <p class="navbar-text navbar-right"><a type="button" style="color: midnightblue" href="#"><span
                        class="fa fa-user-circle"></span> 蒲应明 <small>[注销]</small></a></p>
            </div>
        </div>
    </nav>
{% endblock %}

{% block content %}
    <div>

        {# 主框架 #}

        <div>

            {# 控制栏 #}
            <div class="container-fluid" style="height: 82vh; background: silver">
                <div class="row">
                    <div class="col-md-12" style="height: 77vh; padding: 0">
                        <div class="panel panel-primary">
                            <div class="panel-heading">数据可视化</div>
                            <div class="panel-body" style="height: 80vh">
                                <div class="container-fluid">
                                    <div class="row">
                                        <div class="col-md-6"
                                             style="background: rgba(245,245,220,0.2); height: 50vh; border: 1px rgba(245,245,220,0.2) solid; ">
                                            <div id="A_container" style="height: 45vh; margin: 0; "></div>
                                        </div>
                                        <div class="col-md-3"
                                             style="background: rgba(245,245,220,0.2); height: 50vh; border: 1px rgba(245,245,220,0.2) solid">
                                            <div id="C_container" style="height: 45vh; margin: 0"></div>
                                        </div>
                                        <div class="col-md-3"
                                             style="background: rgba(245,245,220,0.2); height: 50vh; border: 1px rgba(245,245,220,0.2) solid;position: relative">
                                            <select class="form-select" id="date-pick-pie" aria-label="选择日期">
                                                {% for year in years %}
                                                    <option value="{{ year }}">{{ year }}</option>
                                                {% endfor %}
                                            </select>
                                            <div id="B_container" style="height: 45vh; margin: 0">

                                            </div>
                                        </div>
                                    </div>
                                    <div class="row">
                                        <div class="col-md-12"
                                             style="background: rgba(245,245,220,0.2); border: 1px rgba(245,245,220,0.2) solid">
                                            <div id="D_container" style="height: 25vh; margin: 0"></div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="row">
                    <div class="col-md-12" style="height: 10vh">
                        {# 状态栏 #}
                        <div>
                            <div class="container-fluid"
                                 style="color: white; background: rgba(255,255,255,0.3); height: 120px; margin-top: 120px; border-radius: 9px; padding: 10px">
                                <div class="col-md-3">目前输入数据：</div>
                                <div class="col-md-3">采用分析模型：</div>
                                <div class="col-md-3">分析所用数据量：</div>
                                <div class="col-md-3">系统负载：</div>
                            </div>
                            <div class="progress"
                                 style="margin-top: 20px;position: absolute; bottom: 5px; left: 20px; right: 20px; background: #296395">
                                <div class="progress-bar progress-bar-success progress-bar-striped active"
                                     role="progressbar" aria-valuenow="40" aria-valuemin="0" aria-valuemax="100"
                                     style="width: 0">
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

    </div>

    <script type="text/javascript" src="https://cdn.jsdelivr.net/npm/jquery/dist/jquery.min.js"></script>
    <script type="text/javascript" src="https://cdn.jsdelivr.net/npm/echarts@5/dist/echarts.min.js"></script>

    <script type="text/javascript">
        var dom = document.getElementById("A_container");
        var myChart = echarts.init(dom);
        var app = {};

        var option;

        var ROOT_PATH = 'http://127.0.0.1:8000/'

        $.get(
            ROOT_PATH + 'tdata_year',
            function (_rawData) {
                run(JSON.parse(_rawData));
            }
        );

        function run(_rawData) {
            // var countries = ['Australia', 'Canada', 'China', 'Cuba', 'Finland', 'France', 'Germany', 'Iceland', 'India', 'Japan', 'North Korea', 'South Korea', 'New Zealand', 'Norway', 'Poland', 'Russia', 'Turkey', 'United Kingdom', 'United States'];
            const countries = _rawData.names;
            const datasetWithFilters = [];
            const seriesList = [];
            echarts.util.each(countries, function (country) {
                var datasetId = 'dataset_' + country;
                datasetWithFilters.push({
                    id: datasetId,
                    fromDatasetId: 'dataset_raw',
                    transform: {
                        type: 'filter',
                        config: {
                            and: [
                                {dimension: '年份', gte: 2010},
                                {dimension: '类目', '=': country}
                            ]
                        }
                    }
                });
                seriesList.push({
                    type: 'line',
                    datasetId: datasetId,
                    showSymbol: false,
                    name: country,
                    endLabel: {
                        show: true,
                        formatter: function (params) {
                            return params.value[1] + ': ' + params.value[0];
                        }
                    },
                    labelLayout: {
                        moveOverlap: 'shiftY'
                    },
                    emphasis: {
                        focus: 'series'
                    },
                    encode: {
                        x: '年份',
                        y: '产值',
                        label: ['类目', '产值'],
                        itemName: '年份',
                        tooltip: ['产值']
                    }
                });
            });
            option = {
                animationDuration: 10000,
                dataset: [
                    {
                        id: 'dataset_raw',
                        source: _rawData.data
                    },
                    ...datasetWithFilters
                ],
                title: {
                    text: '经济总值曲线图' // 标题部分
                },
                tooltip: {
                    order: 'valueDesc',
                    trigger: 'axis'
                },
                xAxis: {
                    type: 'category',
                    nameLocation: 'middle'
                },
                yAxis: {
                    name: '经济产值'
                },
                grid: {
                    right: 0,
                    left: 0,
                },
                series: seriesList
            };
            myChart.setOption(option);
        }

        if (option && typeof option === 'object') {
            myChart.setOption(option);
        }

    </script>
    <script type="text/javascript">
        var dom_pie = document.getElementById("B_container");
        const select = document.querySelector('#date-pick-pie')
        var myChart_pie = echarts.init(dom_pie);
        var app = {};

        var option;

        function getOData(path, year) {
            return new Promise(resolve => {
                $.ajax({
                    url: 'http://127.0.0.1:8000/' + path,
                    type: 'get',
                    data: {year},
                    dataType: 'json',
                    success(res) {
                        resolve(res)
                    }
                })
            })
        }

        let data = []
        let res;
        (async function () {
            res = await getOData('tdata_every', select.value)

            for (let key in res) {
                data.push({
                    value: +res[key],
                    name: key
                })
            }
            option = {
                title: {
                    text: '各行业产值占比',
                    subtext: '全国',
                    left: 'center'
                },
                tooltip: {
                    trigger: 'item'
                },
                legend: {
                    orient: 'vertical',
                    left: 'left'
                },
                series: [
                    {
                        name: 'Access From',
                        type: 'pie',
                        radius: '50%',
                        data,
                        emphasis: {
                            itemStyle: {
                                shadowBlur: 10,
                                shadowOffsetX: 0,
                                shadowColor: 'rgba(0, 0, 0, 0.5)'
                            }
                        }
                    }
                ]
            };
            if (option && typeof option === 'object') {
                myChart_pie.setOption(option);
            }
        })()

        select.addEventListener('change', async (e) => {
            res = await getOData('tdata_every', select.value)
            data = []
            for (let key in res) {
                data.push({
                    value: +res[key],
                    name: key
                })
            }
            let option = myChart_pie.getOption();
            option.series[0].data = data;
            myChart_pie.setOption(option);
        })

    </script>
    <script type="text/javascript">
        var dom_line = document.getElementById("C_container");
        var myChart_line = echarts.init(dom_line);
        var app = {};

        var option3;

        var ROOT_PATH = 'http://127.0.0.1:8000/'

        myChart_line.showLoading();
        $.get(
            ROOT_PATH + 'rdata_year',
            function (result) {
                result = JSON.parse(result);
                let lengends = []
                var series = result.data.map(item => {
                    const key = Object.keys(item)[0];
                    lengends.push(key);
                    return {
                        name: key,
                        type: 'bar',
                        data: Object.values(item[key])
                    }
                })
                myChart_line.hideLoading();
                option3 = {
                    tooltip: {
                        trigger: 'axis',
                        axisPointer: {
                            type: 'shadow',
                            label: {
                                show: true
                            }
                        }
                    },
                    toolbox: {
                        show: true,
                        feature: {
                            mark: {show: true},
                            dataView: {show: true, readOnly: false},
                            magicType: {show: true, type: ['line', 'bar']},
                            restore: {show: true},
                            saveAsImage: {show: true}
                        }
                    },
                    calculable: true,
                    legend: {
                        data: lengends,
                        itemGap: 5
                    },
                    grid: {
                        top: '12%',
                        left: '1%',
                        right: '10%',
                        containLabel: true
                    },
                    xAxis: [
                        {
                            type: 'category',
                            data: result.names
                        }
                    ],
                    yAxis: [
                        {
                            type: 'value',
                            name: '',
                            axisLabel: {
                                formatter: function (a) {
                                    a = +a;
                                    return isFinite(a) ? echarts.format.addCommas(+a / 1000) : '';
                                }
                            }
                        }
                    ],
                    dataZoom: [
                        {
                            show: true,
                            start: 0,
                            end: 100
                        },
                        {
                            type: 'inside',
                            start: 0,
                            end: 100
                        },
                        {
                            show: true,
                            yAxisIndex: 0,
                            filterMode: 'empty',
                            width: 30,
                            height: '80%',
                            showDataShadow: false,
                            left: '93%'
                        }
                    ],
                    series
                };
                myChart_line.setOption(option3);
            }
        );

        if (option3 && typeof option3 === 'object') {
            myChart_line.setOption(option3);
        }

    </script>
    <script type="text/javascript">
        (async function () {
            let res = await new Promise(resolve => {
                $.ajax({
                    url: 'http://127.0.0.1:8000/tdata_total',
                    type: 'get',
                    dataType: 'json',
                    success(res) {
                        resolve(res)
                    }
                })
            });
            let pList = res.names;
            const years = res.years;
            let minYear = years[0]
            let maxYear = years[years.length - 1];
            dataMap.dataGDP = dataFormatter(res.data, minYear, maxYear, pList);
            let data = years.map(item => `${item}-01-01`)
            let options = res.data.map((item, index) => {
                let year = Object.keys(item)[0]
                return {
                    title: {text: `${year}全国宏观经济指标`},
                    series: [
                        {data: dataMap.dataGDP[index][year]},
                        {
                            data: res.lists.map((item, index2) => {
                                return {name: item, value: res.data2[index][year][index2]}
                            })
                        }
                    ]
                }
            });
            console.log(options)
            option = {
                baseOption: {
                    timeline: {
                        axisType: 'category',
                        // realtime: false,
                        // loop: false,
                        autoPlay: true,
                        // currentIndex: 2,
                        playInterval: 500,
                        // controlStyle: {
                        //     position: 'left'
                        // },
                        data,
                        label: {
                            formatter: function (s) {
                                return new Date(s).getFullYear();
                            }
                        }
                    },
                    title: {
                        subtext: '数据来自国家统计局'
                    },
                    tooltip: {},
                    legend: {
                        left: 'right',
                        data: ['GDP']
                    },
                    calculable: true,
                    grid: {
                        top: 0,
                        bottom: 100,
                        left: 0,
                        right: 0,
                        tooltip: {
                            trigger: 'axis',
                            axisPointer: {
                                type: 'shadow',
                                label: {
                                    show: true,
                                    formatter: function (params) {
                                        return params.value.replace('\n', '');
                                    }
                                }
                            }
                        }
                    },
                    xAxis: [
                        {
                            type: 'category',
                            axisLabel: {interval: 0},
                            data: pList.map((item, index) => {
                                if (index % 2 !== 0) {
                                    return `\n${item}`
                                } else {
                                    return `${item}`
                                }
                            }),
                            splitLine: {show: false}
                        }
                    ],
                    yAxis: [
                        {
                            type: 'value',
                            name: 'GDP（亿元）'
                        }
                    ],
                    series: [
                        {name: 'GDP', type: 'bar'},
                        {
                            name: 'GDP占比',
                            type: 'pie',
                            center: ['85%', '25%'],
                            radius: '28%',
                            z: 100
                        }
                    ]
                },
                options
            };

            if (option && typeof option === 'object') {
                myChart_fin.setOption(option);
            }
        })()
        var dom_fin = document.getElementById("D_container");
        var myChart_fin = echarts.init(dom_fin);
        var app = {};

        var option;


        var dataMap = {};

        function dataFormatter(obj, maxYear, minYear, pList) {
            var temp;
            for (var year = minYear; year <= maxYear; year++) {
                var max = 0;
                temp = obj[year];
                for (var i = 0, l = temp.length; i < l; i++) {
                    max = Math.max(max, temp[i]);
                    obj[year][i] = {
                        name: pList[i],
                        value: temp[i]
                    };
                }
                obj[year + 'max'] = Math.floor(max / 100) * 100;
            }
            return obj;
        }

    </script>
{% endblock %}